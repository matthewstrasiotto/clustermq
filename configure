#!/usr/bin/env bash
set -e

ZEROMQ_VERSION="4.3.4"
ZEROMQ_URL="https://github.com/zeromq/libzmq/releases/download/v${ZEROMQ_VERSION}/zeromq-${ZEROMQ_VERSION}.tar.gz"
#ZEROMQ_URL="https://api.github.com/repos/zeromq/libzmq/tarball/v${ZEROMQ_VERSION}"

CXX=$(${R_HOME}/bin/R CMD config CXX)
CXXFLAGS=$(${R_HOME}/bin/R CMD config CXXFLAGS)
CPPFLAGS=$(${R_HOME}/bin/R CMD config CPPFLAGS)

PKG_CFLAGS="-DZMQ_STATIC -DZMQ_BUILD_DRAFT_API=1 -fPIC -Ilibzmq/include -Icppzmq"
PKG_LIBS="libzmq/src/.libs/libzmq.a"


if [ "$(git rev-parse --is-inside-work-tree)" ]; then  
  git submodule update --init --recursive
else
  #git clone  https://github.com/zeromq/libzmq.git src/libzmq
  curl -sL "$ZEROMQ_URL" -o src/libzmq.tar.gz && tar xvzf src/libzmq.tar.gz
  git clone  https://github.com/zeromq/cppzmq.git src/cppzmq
fi


if [ ! -f src/libzmq/src/.libs/libzmq.a ]; then
  cd src/libzmq

  if [ -f ./configure ]; then
    ./autogen.sh
  fi

  CXX="$CXX" CXXFLAGS="$CXXFLAGS -fPIC" CPPFLAGS="$CPPFLAGS" ./configure \
      --enable-static \
      --disable-shared \
      --disable-maintainer-mode \
      --enable-drafts \
      --disable-libbsd \
      --disable-libunwind \
      --disable-perf \
      --disable-curve \
      --disable-curve-keygen \
      --disable-ws \
      --disable-radix-tree
  make
  cd -
fi

sed -e "s|@cflags@|$PKG_CFLAGS|" -e "s|@libs@|$PKG_LIBS|" src/Makevars.in > src/Makevars
